<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Caching System (Internal Architecture) · Margins.jl</title><meta name="title" content="Caching System (Internal Architecture) · Margins.jl"/><meta property="og:title" content="Caching System (Internal Architecture) · Margins.jl"/><meta property="twitter:title" content="Caching System (Internal Architecture) · Margins.jl"/><meta name="description" content="Documentation for Margins.jl."/><meta property="og:description" content="Documentation for Margins.jl."/><meta property="twitter:description" content="Documentation for Margins.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="Margins.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">Margins.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Introduction</a></li><li><a class="tocitem" href="../mathematical_foundation/">Mathematical Foundation</a></li><li><a class="tocitem" href="../computational_architecture/">Computational Architecture</a></li><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../reference_grids/">Reference Grids</a></li><li><a class="tocitem" href="../profile_margins/">Profile Analysis</a></li><li><a class="tocitem" href="../population_scenarios/">Population Scenarios</a></li><li><a class="tocitem" href="../second_differences/">Second Differences</a></li><li><a class="tocitem" href="../weights/">Weights</a></li><li><a class="tocitem" href="../grouping/">Population Grouping</a></li><li><a class="tocitem" href="../backend_selection/">Backend Selection</a></li><li><a class="tocitem" href="../performance/">Performance Guide</a></li><li><a class="tocitem" href="../advanced/">Advanced Features</a></li></ul></li><li><a class="tocitem" href="../stata_migration/">Migration Guide</a></li><li><a class="tocitem" href="../comparison/">Package Comparison</a></li><li><a class="tocitem" href="../api/">API Reference</a></li><li><a class="tocitem" href="../examples/">Examples</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Caching System (Internal Architecture)</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Caching System (Internal Architecture)</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/emfeltham/Margins.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/emfeltham/Margins.jl/" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Caching-System-(Internal-Architecture)"><a class="docs-heading-anchor" href="#Caching-System-(Internal-Architecture)">Caching System (Internal Architecture)</a><a id="Caching-System-(Internal-Architecture)-1"></a><a class="docs-heading-anchor-permalink" href="#Caching-System-(Internal-Architecture)" title="Permalink"></a></h1><blockquote><p><strong>Note:</strong> This document describes internal implementation details of the Margins.jl caching system. The caching mechanism is <strong>fully automatic</strong> and requires no user intervention. This documentation is provided for developers, contributors, and users interested in understanding performance characteristics.</p></blockquote><h2 id="User-Perspective:-Automatic-Caching"><a class="docs-heading-anchor" href="#User-Perspective:-Automatic-Caching">User Perspective: Automatic Caching</a><a id="User-Perspective:-Automatic-Caching-1"></a><a class="docs-heading-anchor-permalink" href="#User-Perspective:-Automatic-Caching" title="Permalink"></a></h2><p><strong>TL;DR for Users:</strong> Margins.jl automatically caches compiled formula evaluators. The first call to <code>population_margins()</code> or <code>profile_margins()</code> with a given model compiles the evaluator (~1-10ms overhead), and subsequent calls reuse the cached version (microsecond overhead). No user action required.</p><pre><code class="language-julia hljs"># First call: includes compilation overhead
@time result1 = population_margins(model, data; type=:effects)  # ~5ms

# Second call: uses cached evaluator
@time result2 = population_margins(model, data; type=:effects)  # ~0.3ms (15x faster!)

# Different parameters create new cache entry
@time result3 = population_margins(model, data; type=:predictions)  # ~5ms (new compilation)</code></pre><hr/><h2 id="Implementation-Details"><a class="docs-heading-anchor" href="#Implementation-Details">Implementation Details</a><a id="Implementation-Details-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation-Details" title="Permalink"></a></h2><h3 id="Introduction"><a class="docs-heading-anchor" href="#Introduction">Introduction</a><a id="Introduction-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction" title="Permalink"></a></h3><p>The computation of marginal effects involves repeated evaluation of compiled formula representations and their derivatives. To minimize computational overhead, Margins.jl implements a caching mechanism that preserves compiled evaluators and their associated memory buffers across multiple invocations. This section describes the architecture and implementation of this caching system.</p><h2 id="System-Architecture"><a class="docs-heading-anchor" href="#System-Architecture">System Architecture</a><a id="System-Architecture-1"></a><a class="docs-heading-anchor-permalink" href="#System-Architecture" title="Permalink"></a></h2><h3 id="Cache-Structure"><a class="docs-heading-anchor" href="#Cache-Structure">Cache Structure</a><a id="Cache-Structure-1"></a><a class="docs-heading-anchor-permalink" href="#Cache-Structure" title="Permalink"></a></h3><p>The package maintains a global dictionary that maps configuration hashes to pre-compiled engine instances:</p><pre><code class="language-julia hljs">const ENGINE_CACHE = Dict{UInt64, MarginsEngine}()</code></pre><p>Each <code>MarginsEngine</code> encapsulates a compiled formula evaluator from FormulaCompiler.jl along with pre-allocated buffers necessary for computation. The cache key uniquely identifies the computational context through a hash of relevant parameters.</p><h3 id="Configuration-Identification"><a class="docs-heading-anchor" href="#Configuration-Identification">Configuration Identification</a><a id="Configuration-Identification-1"></a><a class="docs-heading-anchor-permalink" href="#Configuration-Identification" title="Permalink"></a></h3><p>The cache key encompasses all parameters that affect the computational procedure:</p><pre><code class="language-julia hljs">cache_key = hash((
    usage,                      # Computational pattern (population or profile)
    deriv,                      # Derivative requirement specification
    model,                      # Statistical model with fitted parameters
    keys(data_nt),             # Data structure specification
    vars,                      # Variables requiring derivative computation
    typeof(model),             # Model type for method dispatch
    fieldnames(typeof(model)), # Model structure specification
    vcov                       # Variance-covariance specification
))</code></pre><p>This comprehensive key ensures that distinct computational contexts maintain separate cache entries, preventing inadvertent reuse of incompatible compiled structures.</p><h3 id="Retrieval-Mechanism"><a class="docs-heading-anchor" href="#Retrieval-Mechanism">Retrieval Mechanism</a><a id="Retrieval-Mechanism-1"></a><a class="docs-heading-anchor-permalink" href="#Retrieval-Mechanism" title="Permalink"></a></h3><p>The cache employs a standard memoization pattern through Julia&#39;s <code>get!</code> function:</p><pre><code class="language-julia hljs">function get_or_build_engine(usage, deriv, model, data_nt, vars, vcov)
    cache_key = hash(...)

    return get!(ENGINE_CACHE, cache_key) do
        build_engine(usage, deriv, model, data_nt, vars, vcov)
    end
end</code></pre><p>When a configuration is encountered for the first time, the system constructs a new engine instance. Subsequent requests with identical configurations retrieve the existing instance without recompilation.</p><h2 id="Computational-Implications"><a class="docs-heading-anchor" href="#Computational-Implications">Computational Implications</a><a id="Computational-Implications-1"></a><a class="docs-heading-anchor-permalink" href="#Computational-Implications" title="Permalink"></a></h2><h3 id="Compilation-Overhead-Reduction"><a class="docs-heading-anchor" href="#Compilation-Overhead-Reduction">Compilation Overhead Reduction</a><a id="Compilation-Overhead-Reduction-1"></a><a class="docs-heading-anchor-permalink" href="#Compilation-Overhead-Reduction" title="Permalink"></a></h3><p>The construction of formula evaluators involves several computationally intensive operations:</p><ol><li>Formula parsing and algebraic expansion</li><li>Categorical variable encoding and level extraction</li><li>Interaction term construction and indexing</li><li>Derivative graph construction for automatic differentiation</li><li>Memory buffer allocation and sizing</li></ol><p>Through caching, these operations occur once per unique configuration rather than for each marginal effects computation. Consider the following timing comparison:</p><pre><code class="language-julia hljs"># Initial computation requires compilation
@time result1 = population_margins(model, data; vars=[:x1, :x2])
# 0.003456 seconds

# Subsequent computation uses cached evaluator
@time result2 = population_margins(model, data; vars=[:x1, :x2])
# 0.000234 seconds</code></pre><p>The order-of-magnitude reduction in computation time reflects the elimination of compilation overhead.</p><h3 id="Memory-Buffer-Management"><a class="docs-heading-anchor" href="#Memory-Buffer-Management">Memory Buffer Management</a><a id="Memory-Buffer-Management-1"></a><a class="docs-heading-anchor-permalink" href="#Memory-Buffer-Management" title="Permalink"></a></h3><p>Each cached engine maintains pre-allocated buffers sized according to its usage pattern:</p><pre><code class="language-julia hljs">struct MarginsEngine{L, U, D}
    compiled::FormulaCompiler.UnifiedCompiled
    de::Union{FormulaCompiler.DerivativeEvaluator, Nothing}

    # Pre-allocated computation buffers
    g_buf::Vector{Float64}           # Gradient storage
    gβ_accumulator::Vector{Float64}  # Accumulator for averaged effects
    η_buf::Vector{Float64}           # Linear predictor values
    row_buf::Vector{Float64}         # Design matrix row storage

    # Model parameters and metadata
    model::Any
    β::Vector{Float64}
    Σ::Matrix{Float64}
    link::L
    vars::Vector{Symbol}
    data_nt::NamedTuple
end</code></pre><p>The buffer sizing strategy differs between usage patterns:</p><ul><li><strong>Population analysis</strong>: Buffers sized for single-row operations to minimize memory footprint</li><li><strong>Profile analysis</strong>: Larger buffers accommodate multiple profile evaluations simultaneously</li></ul><h3 id="Type-Specialization"><a class="docs-heading-anchor" href="#Type-Specialization">Type Specialization</a><a id="Type-Specialization-1"></a><a class="docs-heading-anchor-permalink" href="#Type-Specialization" title="Permalink"></a></h3><p>The caching system leverages Julia&#39;s type system to eliminate runtime dispatch overhead. The <code>DerivativeSupport</code> type parameter enables compile-time specialization:</p><pre><code class="language-julia hljs"># Continuous variables requiring derivatives
engine = get_or_build_engine(PopulationUsage, HasDerivatives, ...)
# Returns: MarginsEngine{..., PopulationUsage, HasDerivatives}

# Categorical variables without derivatives
engine = get_or_build_engine(ProfileUsage, NoDerivatives, ...)
# Returns: MarginsEngine{..., ProfileUsage, NoDerivatives}</code></pre><p>This parametric typing eliminates Union type overhead in computational kernels.</p><h2 id="Practical-Considerations"><a class="docs-heading-anchor" href="#Practical-Considerations">Practical Considerations</a><a id="Practical-Considerations-1"></a><a class="docs-heading-anchor-permalink" href="#Practical-Considerations" title="Permalink"></a></h2><h3 id="Cache-Entry-Differentiation"><a class="docs-heading-anchor" href="#Cache-Entry-Differentiation">Cache Entry Differentiation</a><a id="Cache-Entry-Differentiation-1"></a><a class="docs-heading-anchor-permalink" href="#Cache-Entry-Differentiation" title="Permalink"></a></h3><p>The caching system creates distinct entries for configurations that differ in any computationally relevant aspect:</p><ol><li><p><strong>Model variation</strong>: Different fitted models, even with identical formulas, maintain separate cache entries due to distinct coefficient values.</p></li><li><p><strong>Covariance specification</strong>: Each variance-covariance estimator (e.g., robust, clustered) requires its own cache entry as it affects standard error computation.</p></li><li><p><strong>Variable selection</strong>: Different sets of variables for marginal effects analysis necessitate distinct derivative evaluators.</p></li><li><p><strong>Usage patterns</strong>: Population and profile analyses employ different buffer sizing strategies and thus maintain separate cache entries.</p></li></ol><h3 id="Memory-Management"><a class="docs-heading-anchor" href="#Memory-Management">Memory Management</a><a id="Memory-Management-1"></a><a class="docs-heading-anchor-permalink" href="#Memory-Management" title="Permalink"></a></h3><p>The memory footprint of cached engines scales with the number of unique configurations encountered during a session. For a model with p predictors, each engine requires approximately O(p²) memory, dominated by the variance-covariance matrix storage.</p><p>Typical usage patterns exhibit bounded cache growth:</p><ul><li>Standard analysis sessions: 1-10 unique configurations</li><li>Complex comparative studies: 10-100 configurations</li><li>Long-running services: Periodic cache clearing may be warranted</li></ul><h4 id="Internal-Cache-Management-(Not-Exported)"><a class="docs-heading-anchor" href="#Internal-Cache-Management-(Not-Exported)">Internal Cache Management (Not Exported)</a><a id="Internal-Cache-Management-(Not-Exported)-1"></a><a class="docs-heading-anchor-permalink" href="#Internal-Cache-Management-(Not-Exported)" title="Permalink"></a></h4><p>For advanced users and developers, the package provides internal utilities for cache management. These are <strong>not exported</strong> and require qualified access:</p><pre><code class="language-julia hljs"># Query cache statistics (internal function)
stats = Margins.get_cache_stats()
# Returns: (entries = n, memory_estimate = bytes, keys = [...])

# Clear cache to reclaim memory (internal function)
Margins.clear_engine_cache!()</code></pre><p><strong>Note:</strong> These functions are primarily for debugging and development. Most users will never need to call them directly, as Julia&#39;s garbage collection handles memory management automatically when MarginsEngine instances are no longer referenced.</p><h3 id="Performance-Characteristics"><a class="docs-heading-anchor" href="#Performance-Characteristics">Performance Characteristics</a><a id="Performance-Characteristics-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-Characteristics" title="Permalink"></a></h3><p>Empirical measurements demonstrate the performance impact of caching for a generalized linear model with 10 predictors and 100,000 observations:</p><table><tr><th style="text-align: right">Computation Type</th><th style="text-align: right">Initial (ms)</th><th style="text-align: right">Cached (ms)</th><th style="text-align: right">Ratio</th></tr><tr><td style="text-align: right">Population margins</td><td style="text-align: right">45</td><td style="text-align: right">3</td><td style="text-align: right">15:1</td></tr><tr><td style="text-align: right">Profile margins (10 profiles)</td><td style="text-align: right">8</td><td style="text-align: right">0.5</td><td style="text-align: right">16:1</td></tr><tr><td style="text-align: right">Bootstrap standard errors (1000 iterations)</td><td style="text-align: right">45,000</td><td style="text-align: right">3,000</td><td style="text-align: right">15:1</td></tr></table><p>These measurements reflect the elimination of compilation overhead while preserving computational correctness.</p><h2 id="Implementation-Details-2"><a class="docs-heading-anchor" href="#Implementation-Details-2">Implementation Details</a><a class="docs-heading-anchor-permalink" href="#Implementation-Details-2" title="Permalink"></a></h2><h3 id="Thread-Safety-Considerations"><a class="docs-heading-anchor" href="#Thread-Safety-Considerations">Thread Safety Considerations</a><a id="Thread-Safety-Considerations-1"></a><a class="docs-heading-anchor-permalink" href="#Thread-Safety-Considerations" title="Permalink"></a></h3><p>The current implementation does not provide thread-safe cache access. Concurrent access from multiple threads may result in race conditions. For parallel computation, two strategies are available:</p><ol><li>Pre-populate the cache before initiating parallel computation</li><li>Implement thread-local caches (not currently supported)</li></ol><h3 id="Cache-Invalidation"><a class="docs-heading-anchor" href="#Cache-Invalidation">Cache Invalidation</a><a id="Cache-Invalidation-1"></a><a class="docs-heading-anchor-permalink" href="#Cache-Invalidation" title="Permalink"></a></h3><p>The cache does not automatically detect changes to model coefficients that occur outside the standard fitting procedures. Manual coefficient modification requires explicit cache clearing:</p><pre><code class="language-julia hljs"># Fit model and compute margins
model = lm(@formula(y ~ x), data)
result1 = population_margins(model, data)

# Manual coefficient update (atypical scenario)
model.pp.beta0 .= new_coefficients

# Clear cache to ensure consistency (internal function)
Margins.clear_engine_cache!()
result2 = population_margins(model, data)</code></pre><h3 id="Backward-Compatibility"><a class="docs-heading-anchor" href="#Backward-Compatibility">Backward Compatibility</a><a id="Backward-Compatibility-1"></a><a class="docs-heading-anchor-permalink" href="#Backward-Compatibility" title="Permalink"></a></h3><p>The system provides automatic derivative support detection for legacy code:</p><pre><code class="language-julia hljs"># Explicit specification (recommended)
get_or_build_engine(PopulationUsage, HasDerivatives, model, data_nt, vars, vcov)

# Automatic detection (backward compatible)
get_or_build_engine(PopulationUsage, model, data_nt, vars, vcov)</code></pre><p>The automatic detection examines the data types to determine whether derivative computation is required.</p><h2 id="Theoretical-Foundation"><a class="docs-heading-anchor" href="#Theoretical-Foundation">Theoretical Foundation</a><a id="Theoretical-Foundation-1"></a><a class="docs-heading-anchor-permalink" href="#Theoretical-Foundation" title="Permalink"></a></h2><p>The caching system exploits the mathematical property that marginal effects computation for a given model configuration involves deterministic transformations of the design matrix and coefficient vector. For a model with linear predictor η = Xβ, the marginal effect computation:</p><p>∂E[y|X]/∂xⱼ = g&#39;(η) × βⱼ</p><p>depends only on the model structure, coefficients, and link function. By caching the compiled representation of these transformations, the system avoids redundant symbolic and numerical preprocessing while preserving exact numerical equivalence.</p><h2 id="Future-Directions"><a class="docs-heading-anchor" href="#Future-Directions">Future Directions</a><a id="Future-Directions-1"></a><a class="docs-heading-anchor-permalink" href="#Future-Directions" title="Permalink"></a></h2><p>Several enhancements to the caching system are under consideration:</p><ol><li><strong>Least-recently-used eviction</strong>: Automatic cache size management through LRU policies</li><li><strong>Thread-local storage</strong>: Safe concurrent access through thread-specific caches</li><li><strong>Weak references</strong>: Enable garbage collection of unused engines while preserving active ones</li><li><strong>Persistent caching</strong>: Serialization of compiled engines for cross-session reuse</li></ol><p>These enhancements would extend the applicability of the caching system to more diverse computational contexts while maintaining the current guarantees of numerical correctness.</p><h2 id="Related-Documentation"><a class="docs-heading-anchor" href="#Related-Documentation">Related Documentation</a><a id="Related-Documentation-1"></a><a class="docs-heading-anchor-permalink" href="#Related-Documentation" title="Permalink"></a></h2><ul><li><a href="../computational_architecture/">Computational Architecture</a>: FormulaCompiler.jl integration and evaluation strategies</li><li><a href="../performance/">Performance Guide</a>: Computational complexity analysis and optimization strategies</li><li><a href="../api/">API Reference</a>: Cache management function specifications</li></ul></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Saturday 18 October 2025 14:24">Saturday 18 October 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
